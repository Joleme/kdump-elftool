From c8b7d3a302014ef49f1897635d1adae729686e1f Mon Sep 17 00:00:00 2001
From: Corey Minyard <cminyard@mvista.com>
Date: Wed, 3 Feb 2016 09:13:54 -0600
Subject: [PATCH 1/3] mips: Add kernel entry point to kernel crashdump info

For gdb to debug a relocated kernel, it needs to know the actual
point of kernel entry in AT_ENTRY in the .auxv note.  So add that
entry to the crashdump information so the kdump extraction tools
can get it.

Signed-off-by: Corey Minyard <cminyard@mvista.com>
---
 arch/mips/kernel/machine_kexec.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/arch/mips/kernel/machine_kexec.c b/arch/mips/kernel/machine_kexec.c
index 299ed22..795f362 100644
--- a/arch/mips/kernel/machine_kexec.c
+++ b/arch/mips/kernel/machine_kexec.c
@@ -114,6 +114,12 @@ machine_kexec(struct kimage *image)
 	((noretfun_t) reboot_code_buffer)();
 }
 
+#ifdef CONFIG_MAPPED_KERNEL
+extern void phys_entry(void);
+#else
+extern void kernel_entry(void);
+#endif
+
 void arch_crash_save_vmcoreinfo(void)
 {
 	VMCOREINFO_NUMBER(PAGE_SHIFT);
@@ -141,4 +147,14 @@ void arch_crash_save_vmcoreinfo(void)
 	VMCOREINFO_ADDRESS(PAGE_OFFSET);
 	VMCOREINFO_ADDRESS(IO_BASE);
 	VMCOREINFO_NUMBER(_PFN_SHIFT);
+
+#if defined(CONFIG_RELOCATABLE) || defined (CONFIG_RANDOMIZE_BASE)
+#ifdef CONFIG_MAPPED_KERNEL
+	vmcoreinfo_append_str("ADDRESS(%s)=%llx\n", "entry",
+			      (unsigned long long) phys_entry);
+#else
+	vmcoreinfo_append_str("ADDRESS(%s)=%llx\n", "entry",
+			      (unsigned long long) kernel_entry);
+#endif
+#endif
 }
-- 
2.5.0

