From 3938dafec73caf8374ce6882e0f738e4818ebdc0 Mon Sep 17 00:00:00 2001
From: Corey Minyard <cminyard@mvista.com>
Date: Wed, 3 Feb 2016 09:18:25 -0600
Subject: [PATCH 2/3] x86: Add kernel entry point to kernel crashdump info

For gdb to debug a relocated kernel, it needs to know the actual
point of kernel entry in AT_ENTRY in the .auxv note.  So add that
entry to the crashdump information so the kdump extraction tools
can get it.

Signed-off-by: Corey Minyard <cminyard@mvista.com>
---
 arch/x86/kernel/machine_kexec_32.c | 6 ++++++
 arch/x86/kernel/machine_kexec_64.c | 6 ++++++
 2 files changed, 12 insertions(+)

diff --git a/arch/x86/kernel/machine_kexec_32.c b/arch/x86/kernel/machine_kexec_32.c
index 6476a76..6154470 100644
--- a/arch/x86/kernel/machine_kexec_32.c
+++ b/arch/x86/kernel/machine_kexec_32.c
@@ -259,6 +259,8 @@ void machine_kexec(struct kimage *image)
 	__ftrace_enabled_restore(save_ftrace_enabled);
 }
 
+extern void phys_startup_32(void);
+
 void arch_crash_save_vmcoreinfo(void)
 {
 #ifdef CONFIG_NUMA
@@ -268,5 +270,9 @@ void arch_crash_save_vmcoreinfo(void)
 #ifdef CONFIG_X86_PAE
 	VMCOREINFO_CONFIG(X86_PAE);
 #endif
+#ifdef CONFIG_RELOCATABLE
+	vmcoreinfo_append_str("ADDRESS(%s)=%llx\n", "entry",
+			      (unsigned long long) phys_startup_32);
+#endif
 }
 
diff --git a/arch/x86/kernel/machine_kexec_64.c b/arch/x86/kernel/machine_kexec_64.c
index 679cef0..63b9015 100644
--- a/arch/x86/kernel/machine_kexec_64.c
+++ b/arch/x86/kernel/machine_kexec_64.c
@@ -270,6 +270,8 @@ void machine_kexec(struct kimage *image)
 	__ftrace_enabled_restore(save_ftrace_enabled);
 }
 
+extern void phys_startup_64(void);
+
 void arch_crash_save_vmcoreinfo(void)
 {
 	VMCOREINFO_SYMBOL(phys_base);
@@ -279,6 +281,10 @@ void arch_crash_save_vmcoreinfo(void)
 	VMCOREINFO_SYMBOL(node_data);
 	VMCOREINFO_LENGTH(node_data, MAX_NUMNODES);
 #endif
+#ifdef CONFIG_RELOCATABLE
+	vmcoreinfo_append_str("ADDRESS(%s)=%llx\n", "entry",
+			      (unsigned long long) phys_startup_64);
+#endif
 	vmcoreinfo_append_str("KERNELOFFSET=%lx\n",
 			      (unsigned long)&_text - __START_KERNEL);
 }
-- 
2.5.0

